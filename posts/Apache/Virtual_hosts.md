Title: Apache. Virtual hosts
Pub date: 05.02.2016
Category: Apache, 

_Срані індєйци і мої витікші мозги._
_ Шоб вам пусто було._

-----


<h2>1. Введение</h2>
При запуске нескольких веб-сайтов на сервере в качестве нескольких виртуальных хостов, могут возникнуть ошибки, например опечатка в host configuration. Результат - вместо требуемого содержания будет отображаться содержание первого по порядку хоста. Это не является желательным, поэтому лучше задать определенную общую страницу для этого случая.
<h2>2. Проблемы</h2>
При поиске соответствующего виртуального хоста по конкретному запросу, Apache проходит по отсортированному списку хостов до конца, и если они не совпадают с требуемым - использует первый виртуальный хост для выдачи.
<h2>3. Решение</h2>
Добавить общий виртуальный хост, который будет использоваться вместо нынешнего первого.
<h2>4. Задание виртуальных хостов в httpd.conf</h2>
Наиболее простым методом добавления виртуальных контейнергов является редактирование файла -** /etc/httpd/conf/httpd.conf**.

Чтобы сконфигурировать виртуальные хосты на базе имен, нам понадобиться раскомментировать дериктиву **NameVirtualHost** с аргументом * (шаблон, означающий "все имена хостов"), за которым следует столько разных блоков **&lt;VirtualHost *:80&gt;**, сколько нам нужно.

&nbsp;
<pre>NameVirtualHost *:80</pre>
&nbsp;
<pre>&lt;VirtualHost *:80&gt;
    ServerAdmin username1@example.com
    DocumentRoot /home/username1/www/user1domain.ru
    ServerName user1domain.ru
    ServerAlias www.user1domain.ru
    ErrorLog logs/user1domain.ru-error_log
    CustomLog logs/user1domain.ru-access_log common
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerAdmin username2@example.org
    DocumentRoot /var/www/html/user2.example.ru
    ServerName user2.example.ru
    ErrorLog logs/user2.example.ru-error_log
    CustomLog logs/user2.example.ru-access_log common
&lt;/VirtualHost&gt;</pre>
Внутри контейнера **&lt;VirtualHost * :80&gt;** директива **ServerName** определяет имя хоста, с которым сравнивается заголовок **Host:**, и при совпадении включается соответствующий набор переопределений. **DocumentRoot** специфицирует, где в файловой системе нужно искать файлы, указанные в принятом запросе, а директивы **ErrorLog** и **CustomLog** задают альтернативные файлы протоколов для каждого виртуального хоста. **ServerAlias **предостовляет возможность перечислить альтернативные имена для каждого виртуального хоста. Вы можете включать различные директивы по своему вкусу, до тех пор, пока они допускаются внутри блока **&lt;VirtualHost * :80&gt;**. Для проверки отсутствия ошибок в конфигурации выполните:
<pre># apachectl configtest
</pre>
Виртуальные хосты могут конфигурироваться различными способами, позволяя вам указывать разные IP-адреса и порты для соответствия определенным группам блоков **&lt;VirtualHost&gt;**.
<h2>5. Файлы виртуальных хостов Apache</h2>
Второй способ конфигурирования виртуальных контейнеров Apache - размещение их в отдельных файлах в выделенной для этого директории. Эта процедура описана подробно в '<a href="http://centos.name/?page/tipsandtricks/ApacheVhostDir">виртуальные хосты Apache в отдельных файлах</a>'.

При вставке в качестве первого хоста (в нашем случае странички-заглушки), имя файла должно распологаться первым, как 0Default.conf. А последний хост в списке соответственно - zDefault.conf.
<h2>6. Первый виртуальный хост</h2>
Что произойдет при обращении к серверу по несуществующему имени или по IP?

Если оставить все как в примере выше, то будет открываться первый сайт user1domain.ru. Поэтому перед секциями рабочих сайтов разместим секцию заглушку:
<pre>&lt;VirtualHost *:80&gt; 
   ServerName default
   DocumentRoot /var/www/html/default 
&lt;/VirtualHost&gt; 
</pre>
Теперь "по умолчанию" все идут в /var/www/html/default/, в котором можно разместить файлик **'index.htm'**.
<h2>7. Последний виртуальный хост</h2>
Как отловить все запросы хостам, то есть соответствовать всем? Это можно сделать (в принципе не обязательно) вот так:
<pre>&lt;VirtualHost *:80&gt;
  ServerAlias *
&lt;/VirtualHost&gt;
</pre>
<h2>8. Перезапуск Apache</h2>
Чтобы изменения вступили в силу, перезапустите Apache.
<pre>service httpd graceful
</pre>
<h2>9. Apache: доступ к домашним папкам</h2>
По умолчанию директория, в которой может хозяйничать apache /var/www. За этим зорко следит selinux.
<pre>setsebool -P httpd_enable_homedirs 1</pre>
Эта команда разрешает апачу обращаться к домашним директориям.
<pre>chcon -R -t httpd_sys_content_t /home/myprojects/sitename</pre>
Пометить данную папку как объект разрешенный апачу.

-----

<a href="http://centos.name/?page/tipsandtricks/ApacheVhostDefault" target="_blank">Пишуть люди</a>

-----